(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{443:function(t,n,s){"use strict";s.r(n);var a=s(2),e=Object(a.a)({},(function(){var t=this,n=t._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"_09-事件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_09-事件"}},[t._v("#")]),t._v(" 09.事件")]),t._v(" "),n("p",[t._v("事件是能方便地调用以太坊虚拟机日志功能的接口。应用程序可以通过以太坊客户端的 RPC 接口订阅和监听这些事件。")]),t._v(" "),n("p",[n("strong",[t._v("重点:记录区块链的日志，可以使用状态变量，也可以使用事件 Event，但 Event 使用的 gas 费比状态变量低。")])]),t._v(" "),n("p",[t._v("原则：改变状态变量时，一定要触发事件。")]),t._v(" "),n("p",[t._v("Soliddity Event 事件是以太坊虚拟机(EVM)日志基础设施提供的一个便利接口。当被发送事件（调用）时，会触发参数存储到交易的日志中。这些日志与合约的地址关联，并记录到区块链中。每个交易收据包含 0 到多个 log 记录，log 表明着智能合约所触发的事件。")]),t._v(" "),n("h2",{attrs:{id:"_1️⃣-event-语法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1️⃣-event-语法"}},[t._v("#")]),t._v(" 1️⃣ Event 语法")]),t._v(" "),n("p",[n("strong",[t._v("事件的定义")]),t._v(":使用 "),n("code",[t._v("event")]),t._v(" 关键字来定义一个事件 Event，语法如下：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("event EventName(<parameter list>);\n")])])]),n("p",[n("strong",[t._v("事件的触发")]),t._v(":只能使用 "),n("code",[t._v("emit")]),t._v(" 关键字来触发事件 Event，语法如下：")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("emit EventName(<parameter list>);\n")])])]),n("h2",{attrs:{id:"_2️⃣-四种事件定义方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2️⃣-四种事件定义方式"}},[t._v("#")]),t._v(" 2️⃣ 四种事件定义方式")]),t._v(" "),n("ol",[n("li",[t._v("不带参数的 event")]),t._v(" "),n("li",[t._v("带参数的 event")]),t._v(" "),n("li",[t._v("带参数名的 event")]),t._v(" "),n("li",[t._v("带 indexed 参数名的 event\n"),n("ol",[n("li",[t._v("这种事件也被称为"),n("strong",[t._v("索引事件")])]),t._v(" "),n("li",[t._v("语法:"),n("code",[t._v("event EventName(TypeName indexed varibleName....);")])]),t._v(" "),n("li",[t._v("事件中 indexed 标记过的参数，可以在链外进行搜索查询。")]),t._v(" "),n("li",[t._v("一个事件中 indexed 标记过的参数最多有 3 个。")])])])]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('// SPDX-License-Identifier: MIT\npragma solidity ^0.8.17;\n\ncontract Event {\n    // 普通 event\n    event Log1(address, string);\n\n    // 带名字的 event\n    event Log2(address ads, string msg);\n\n    // 带 indexed 的event\n    event Log3(address indexed ads, string msg);\n\n    // indexed 在一个事件内使用次数不能超过3次\n    event Transfer(\n        address indexed from,\n        address indexed to,\n        uint256 indexed amount\n    );\n\n    function log1() external {\n        emit Log1(msg.sender, "Log111");\n    }\n\n    function log2() external {\n        emit Log2(msg.sender, "Log222");\n    }\n\n    function log3() external {\n        emit Log3(msg.sender, "Log333");\n    }\n\n    function transfer(address _to, uint256 amount) external {\n        emit Transfer(msg.sender, _to, amount);\n    }\n}\n')])])]),n("h3",{attrs:{id:"_1-不带参数的-event"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-不带参数的-event"}},[t._v("#")]),t._v(" 1 不带参数的 event")]),t._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"from"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x7874d94b8f9E2a28FCceCE404666C984f33a82b8"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"topic"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x1732d0c17008d342618e7f03069177d8d39391d79811bb4e706d7c6c84108c0f"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"event"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"args"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),n("h3",{attrs:{id:"_2-带参数的-event"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-带参数的-event"}},[t._v("#")]),t._v(" 2 带参数的 event")]),t._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"from"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x7874d94b8f9E2a28FCceCE404666C984f33a82b8"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"topic"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x54010eb0426bdddd13273086604fca7ba750a84093c6839732d954056646e81b"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"event"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"args"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"0"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"1"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log222"')]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),n("h3",{attrs:{id:"_3-带参数名的-event"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-带参数名的-event"}},[t._v("#")]),t._v(" 3 带参数名的 event")]),t._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"from"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x7874d94b8f9E2a28FCceCE404666C984f33a82b8"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"topic"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x940879bf2d29cdfe8084f2f033d2168f5859a6e10530b61fb84dc1c5ddc9ca40"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"event"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log3"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"args"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"0"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"1"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log333"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"ads"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"msg"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log333"')]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),n("h3",{attrs:{id:"_4-带-indexed-参数名的-event"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-带-indexed-参数名的-event"}},[t._v("#")]),t._v(" 4 带 indexed 参数名的 event")]),t._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"from"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0xfB72aAdB17a855D27A68B565ee0a84CB30A387e4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"topic"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0xf485c071883274befba21423da7f60203f9df753bf614bca26c4763ed4b240fb"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"event"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"args"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"0"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"1"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log444"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"ads"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"msg"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Log444"')]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"from"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0xfB72aAdB17a855D27A68B565ee0a84CB30A387e4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"topic"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"event"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Transfer"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"args"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"0"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"1"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"2"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"from"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"to"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x5B38Da6a701c568545dCfcB03FcB875f56beddC4"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"amount"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),n("h2",{attrs:{id:"_3️⃣-indexed-的作用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3️⃣-indexed-的作用"}},[t._v("#")]),t._v(" 3️⃣ indexed 的作用")]),t._v(" "),n("p",[t._v("indexed 数据会被记录到 "),n("code",[t._v("topics")]),t._v(" 中，可以用于检索。已索引的部分，最多有 3 个（对于非匿名事件）或 4 个（对于匿名事件）")]),t._v(" "),n("p",[t._v("对于非匿名事件，最多三个参数可以接收 "),n("code",[t._v("indexed")]),t._v('属性（它是一个特殊的名为: "主题" 的数据结构，而不作为日志的数据部分）。主题仅有 32 字节， 因此如果:引用类型 标记为索引项，则它们的 keccak-256 哈希值会被作为 主题（topic） 保存。')]),t._v(" "),n("p",[t._v("主题（topic）让我们可以可以搜索事件，比如在为某些事件过滤一些区块，还可以按发起事件的合同地址来过滤事件。")]),t._v(" "),n("p",[t._v("例如, 使用如下的 web3.js "),n("code",[t._v('subscribe("logs")方法')]),t._v(" 去过滤符合特定地址的 主题（topic） ：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" options "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("fromBlock")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("address")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" web3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("eth"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("defaultAccount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("topics")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x0000000000000000000000000000000000000000000000000000000000000000"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nweb3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("eth\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("subscribe")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"logs"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"data"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"changed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("主要用在链下服务，可以通过 RPC 获取，比如 web3 的以下方法:")]),t._v(" "),n("ul",[n("li",[n("code",[t._v("myContract.once")]),t._v(" "),n("ul",[n("li",[t._v("https://web3js.readthedocs.io/en/v1.7.5/web3-eth-contract.html")])])]),t._v(" "),n("li",[n("code",[t._v("myContract.events.MyEvent")]),t._v(" "),n("ul",[n("li",[t._v("https://web3js.readthedocs.io/en/v1.7.5/web3-eth-contract.html#contract-events")])])]),t._v(" "),n("li",[n("code",[t._v("myContract.getPastEvents")]),t._v(" "),n("ul",[n("li",[t._v("https://web3js.readthedocs.io/en/v1.7.5/web3-eth-contract.html#getpastevents")])])])]),t._v(" "),n("h2",{attrs:{id:"_4️⃣-log-的使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4️⃣-log-的使用"}},[t._v("#")]),t._v(" 4️⃣ log 的使用")]),t._v(" "),n("p",[t._v("除非你用 "),n("code",[t._v("anonymous")]),t._v(" 声明事件，否则事件签名的哈希值是一个 主题（topic）。同时也意味着对于匿名事件无法通过名字来过滤，仅能按合约地址过滤。匿名事件的优势是他们部署和调用的成本更低。它也允许你声明 4 个索引参与而不是 3 个。")]),t._v(" "),n("p",[t._v('⚠️：由于交易日志只存储事件数据而不存储类型。你必须知道事件的类型，包括哪个参数被索引，以及该事件是否是匿名的，以便正确解释数据。尤其是，有可能使用一个匿名事件来"伪造"另一个事件的签名。')]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("pragma solidity  >=0.4.21 <0.9.0;\n\ncontract ClientReceipt {\n    event Deposit(\n        address indexed from,\n        bytes32 indexed id,\n        uint value\n    );\n\n    function deposit(bytes32 id) public payable {\n        // 事件使用 emit 触发事件。\n        // 我们可以过滤对 `Deposit` 的调用，从而用 Javascript API 来查明对这个函数的任何调用（甚至是深度嵌套调用）。\n        emit Deposit(msg.sender, id, msg.value);\n    }\n}\n")])])]),n("p",[t._v("使用 JavaScript API 调用事件的用法如下：")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" abi "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* abi 由编译器产生 */")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" ClientReceipt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" web3"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("eth"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("contract")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" clientReceipt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ClientReceipt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("at")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x1234...xlb67"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 地址 */")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" depositEvent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" clientReceipt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Deposit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 监听变化")]),t._v("\ndepositEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("watch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 结果包含 非索引参数 以及 主题 topic")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 或者通过传入回调函数，立即开始听监")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" depositEvent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" clientReceipt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Deposit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("上面的输出如下所示（有删减）：")]),t._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"returnValues"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"from"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x1111…FFFFCCCC"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x50…sd5adb20"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"value"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x420042"')]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"raw"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"data"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x7f…91385"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"topics"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0xfd4…b4ead7"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0x7f…1a91385"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h2",{attrs:{id:"_5️⃣-log-重载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5️⃣-log-重载"}},[t._v("#")]),t._v(" 5️⃣ Log 重载")]),t._v(" "),n("p",[t._v("Log 可以像函数一样重载")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('// SPDX-License-Identifier: MIT\npragma solidity ^0.8.17;\n\ncontract Event {\n    event Log(address ads);\n    event Log(address indexed ads, string msg); // 重载\n\n    function log1() external {\n        emit Log(msg.sender);\n    }\n\n    function log2() external {\n        emit Log(msg.sender, "Log111");\n    }\n}\n')])])]),n("h2",{attrs:{id:"🆗-实战-众筹合约"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#🆗-实战-众筹合约"}},[t._v("#")]),t._v(" 🆗 实战: 众筹合约")]),t._v(" "),n("h3",{attrs:{id:"合约代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#合约代码"}},[t._v("#")]),t._v(" 合约代码")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v('// SPDX-License-Identifier: MIT\npragma solidity ^0.8.17;\n\ncontract Croedfund {\n    /* ============ Type Declaration ============ */\n    // 出资人角色\n    // * 仅需记录地址/金额即可\n    struct Donor {\n        address addr; //出资人地址\n        uint256 amount; //出资人金额\n    }\n\n    // 募资人角色\n    // * 用于表示一个募资项目，其中包括募资人地址、目标金额、\n    // 已筹集金额、捐赠者人数、项目状态以及所有的出资人。\n    struct Donee {\n        address creator; // 募资人地址\n        uint256 goal; // 众筹目标数量\n        uint32 startAt; // 开始时间\n        uint32 endAt; // 结束时间\n        bool claimed; // 是否被领取\n        uint256 amount; // 已筹集金额\n        uint256 donorCount; // * 捐赠者人数\n        mapping(uint256 => Donor) donorMap; // * 出资人字典\n    }\n\n    /* ============ State Variables ============ */\n    address payable owner; //合约拥有者\n    uint256 public doneeCount; // 募资人数量\n    mapping(uint256 => Donee) public doneeMap; //募资人字典\n\n    /* ============ Events ============ */\n    event Launch(\n        uint256 id,\n        address indexed creator,\n        uint256 goal,\n        uint32 startAt,\n        uint32 endAt\n    );\n    event Cancel(uint256 id);\n    event Donate(uint256 indexed id, address indexed caller, uint256 amount);\n    event Unpledge(uint256 indexed id, address indexed caller, uint256 amount);\n    event Claim(uint256 id, address creator, uint256 amount);\n    event Refund(uint256 indexed id, address indexed caller, uint256 amount);\n\n    /* ============ Modifier ============ */\n    modifier onlyOwner() {\n        require(msg.sender == owner, "only owner");\n        _;\n    }\n    // 验证募捐活动ID是否有效\n    modifier validDonee(uint256 doneeID) {\n        require(doneeID > 0 && doneeID <= doneeCount);\n        _;\n    }\n\n    /* ============ Errors ============ */\n    error MyError(string);\n\n    /* ============ Constructor ============ */\n    constructor() {\n        owner = payable(msg.sender);\n    }\n\n    /* ============ Functions ============ */\n    // 启动新众筹\n    function launch(\n        address _addr,\n        uint256 _goal,\n        uint32 _startAt,\n        uint32 _endAt\n    ) external onlyOwner {\n        require(_startAt >= block.timestamp, "start at < now");\n        require(_startAt <= _endAt, "start at > end at");\n        require(_endAt <= block.timestamp + 30 days, "end at > max duration");\n\n        doneeCount++;\n\n        Donee storage donee = doneeMap[doneeCount];\n        donee.creator = _addr;\n        donee.goal = _goal;\n        donee.startAt = _startAt;\n        donee.endAt = _endAt;\n        emit Launch(doneeCount, msg.sender, _goal, _startAt, _endAt);\n    }\n\n    // 取消指定ID的众筹\n    function cancel(uint256 _id) external onlyOwner {\n        // 不需要修改，需用 memeory ,但是包含mapping类型，所以需要用 storage\n        Donee storage campaign = doneeMap[_id];\n        require(block.timestamp < campaign.startAt, "started"); // 必须还没有开始\n        delete doneeMap[_id];\n        emit Cancel(_id);\n    }\n\n    // 出资人捐赠\n    function donate(uint256 _id) external payable validDonee(_id) {\n        Donee storage donee = doneeMap[_id]; // 需要修改，所以使用 storage\n        require(block.timestamp >= donee.startAt, "not start"); //\n        require(block.timestamp <= donee.endAt, "ended"); //\n\n        donee.donorCount++;\n        donee.amount += msg.value;\n\n        Donor storage donor = donee.donorMap[donee.donorCount];\n        donor.addr = msg.sender;\n        donor.amount = msg.value;\n\n        emit Donate(_id, msg.sender, msg.value);\n    }\n\n    // 完成目标给募资人转账\n    function transfer(uint256 doneeID) public onlyOwner validDonee(doneeID) {\n        Donee storage donee = doneeMap[doneeID];\n\n        require(!donee.claimed, "is claimed");\n        require(block.timestamp >= donee.endAt, "not ended");\n        require(donee.amount >= donee.goal, "amount < goal");\n\n        // 设置已经支付的状态\n        donee.claimed = true;\n\n        // 给募资人转账\n        payable(donee.creator).transfer(donee.goal);\n        emit Claim(doneeID, msg.sender, donee.amount);\n    }\n\n    /* ============ Helper ============ */\n    fallback() external {}\n\n    receive() external payable {}\n\n    // 获取当前合约的余额\n    function getBalance() public view returns (uint256) {\n        return address(this).balance;\n    }\n\n    // 合约的余额转账到拥有者\n    function withdraw(uint256 doneeID) public onlyOwner {\n        Donee storage donee = doneeMap[doneeID];\n        require(donee.claimed, "not claimed");\n        require(block.timestamp >= donee.endAt, "not ended");\n\n        payable(msg.sender).transfer(address(this).balance);\n    }\n\n    // 获取项目状态\n    function getStatus(uint256 doneeID)\n        public\n        view\n        validDonee(doneeID)\n        returns (bool)\n    {\n        Donee storage donee = doneeMap[doneeID];\n        return (block.timestamp >= donee.startAt &&\n            block.timestamp <= donee.endAt);\n    }\n}\n')])])]),n("h3",{attrs:{id:"测试合约"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试合约"}},[t._v("#")]),t._v(" 测试合约")]),t._v(" "),n("ul",[n("li",[t._v("address1 launch 一次活动\n"),n("ul",[n("li",[t._v("goal 为 10")]),t._v(" "),n("li",[t._v("时间戳获取: "),n("a",{attrs:{href:"https://tool.chinaz.com/tools/unixtime.aspx",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://tool.chinaz.com/tools/unixtime.aspx"),n("OutboundLink")],1)])])]),t._v(" "),n("li",[t._v("doneeMap 查询 id 1 信息")]),t._v(" "),n("li",[t._v("getStatus 查询 id 1 是否开始")]),t._v(" "),n("li",[t._v("address2 donate 6")]),t._v(" "),n("li",[t._v("address3 donate 7")]),t._v(" "),n("li",[t._v("doneeMap 查询 id 1 信息")])])])}),[],!1,null,null,null);n.default=e.exports}}]);